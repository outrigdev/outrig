# Outrig Auto-Updater

This is a Swift-based auto-updater for the Outrig macOS application using the [Sparkle](https://sparkle-project.org/) framework.

## Overview

The auto-updater is a small Swift executable that integrates with the Sparkle framework to provide seamless updates for the Outrig macOS application. When launched, it checks for updates and handles the download and installation process.

## Complete Setup Guide

### 1. Build the Swift Updater

```bash
# Build the OutrigUpdater executable
./build.sh
```

This will compile the Swift code and create the OutrigUpdater binary.

### 2. Generate Sparkle Keys

```bash
# Generate ED25519 keys for signing updates
./generate_keys.sh
```

This script will:
- Generate a public/private key pair for signing updates
- Display the public key to add to your Info.plist
- Save the keys in the `keys` directory

Keep the private key secure - it's used to sign your updates.

### 3. Download Sparkle Framework

Download the latest version of Sparkle from [Sparkle Releases](https://github.com/sparkle-project/Sparkle/releases).

### 4. Integrate with Outrig.app

```bash
# Integrate the updater and Sparkle framework into your app bundle
./integrate_updater.sh /path/to/Outrig.app
```

This script will:
- Copy the OutrigUpdater binary to Outrig.app/Contents/MacOS/
- Copy the Sparkle.framework to Outrig.app/Contents/Frameworks/

### 5. Update Info.plist

The Info.plist.template in macosapp/assets has been updated to include Sparkle configuration:

```xml
<!-- Sparkle configuration -->
<key>SUFeedURL</key>
<string>https://updates.outrig.run/appcast.xml</string>
<key>SUPublicEDKey</key>
<string>[Your Sparkle public key]</string>
<key>SUAutomaticallyUpdate</key>
<true/>
```

Replace `[Your Sparkle public key]` with the public key generated by `generate_keys.sh`.

### 6. Create and Host the Appcast File

1. Generate appcast.xml using the Go-based generator:
   ```bash
   # Requires SPARKLE_PRIVATE_KEY environment variable
   task generate:appcast -- v0.6.0
   ```

2. The generator automatically:
   - Downloads DMG files from GitHub releases
   - Calculates file sizes
   - Generates Ed25519 signatures using your private key
   - Creates properly formatted appcast.xml

3. Host the appcast.xml file at the URL specified in SUFeedURL (e.g., https://updates.outrig.run/appcast.xml)

### 7. Test the Update Process

1. Launch the Outrig app
2. Click on "Check for Updates..." in the menu
3. The OutrigUpdater should launch and check for updates

## Usage from Go Application

The Go application has been updated to include a "Check for Updates..." menu item that launches the OutrigUpdater:

```go
func checkForUpdates() {
    // Get the path to the OutrigUpdater
    execPath, err := os.Executable()
    if err != nil {
        log.Printf("Error getting executable path: %v", err)
        return
    }
    
    // Construct the path to the updater
    updaterPath := filepath.Join(filepath.Dir(execPath), "OutrigUpdater")
    
    // Launch the updater
    cmd := exec.Command(updaterPath)
    cmd.Start()
}
```

## GitHub Actions Integration

The appcast.xml file should reference the DMG files from GitHub releases:

```xml
<enclosure
    url="https://github.com/outrigdev/outrig/releases/download/v0.6.0/Outrig-darwin-amd64-v0.6.0.dmg"
    sparkle:version="0.6.0"
    sparkle:shortVersionString="0.6.0"
    sparkle:os="macos"
    sparkle:arch="x86_64"
    length="12345678"
    type="application/x-apple-diskimage"
    sparkle:edSignature="YOUR_SIGNATURE_HERE" />
```

## Code Signing and Notarization

For distribution, both the Outrig.app bundle and the OutrigUpdater binary should be code-signed and notarized according to Apple's requirements. This is already handled in the GitHub Actions workflow.